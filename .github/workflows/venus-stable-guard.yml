name: Venus Stable Branch Guard

on:
  pull_request:
    branches:
      - venus-stable

jobs:
  check-merge-source:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to check merge base

      - name: Check if PR contains origin/main commits
        run: |
          # Get the base branch (should be venus-stable)
          BASE_REF="${{ github.base_ref }}"

          # Get the head branch
          HEAD_REF="${{ github.head_ref }}"

          echo "Checking PR from $HEAD_REF to $BASE_REF"

          # Fetch all remotes
          git remote add upstream https://github.com/qemu/qemu.git || true
          git fetch origin
          git fetch upstream || true

          # Check if this PR is merging origin/main
          if git merge-base --is-ancestor origin/main HEAD; then
            echo "❌ ERROR: This PR contains commits from origin/main"
            echo ""
            echo "The venus-stable branch should only merge from upstream, not from origin/main."
            echo "origin/main contains breaking zero-copy code that venus-stable excludes."
            echo ""
            echo "See .github/VENUS_STABLE_POLICY.md for details."
            echo ""
            echo "To fix:"
            echo "1. Rebase your branch on venus-stable (not main)"
            echo "2. Or cherry-pick specific commits instead of merging"
            exit 1
          fi

          # Check if this might be a merge commit from main
          MERGE_COMMITS=$(git log --merges --oneline origin/venus-stable..HEAD | grep -i "merge.*main" || true)
          if [ -n "$MERGE_COMMITS" ]; then
            echo "⚠️  WARNING: Found merge commits mentioning 'main':"
            echo "$MERGE_COMMITS"
            echo ""
            echo "Please verify this is from upstream, not origin/main"
          fi

          echo "✅ Branch check passed - no origin/main commits detected"

      - name: Check for breaking commit hashes
        run: |
          # List of breaking commit hashes to reject
          BREAKING_COMMITS=(
            "37f2c7c205"  # milestone zero-copy triangle (QEMU)
            "e3601ea0d0"  # codex wip before zero-copy
            "ad7ec23a30"  # vkcube double buffering
            "1352959d65"  # zero-copy cleanup
          )

          echo "Checking for breaking commits..."
          FOUND_BREAKING=false

          for commit in "${BREAKING_COMMITS[@]}"; do
            if git log --oneline origin/venus-stable..HEAD | grep -q "$commit"; then
              echo "❌ ERROR: Found breaking commit $commit in this PR"
              FOUND_BREAKING=true
            fi
          done

          if [ "$FOUND_BREAKING" = true ]; then
            echo ""
            echo "This PR contains commits that broke Venus rendering."
            echo "venus-stable specifically excludes these commits."
            echo ""
            echo "See notes/root-cause-found.md for details."
            exit 1
          fi

          echo "✅ No breaking commits detected"

      - name: Summary
        if: success()
        run: |
          echo "✅ Venus stable branch guard passed!"
          echo ""
          echo "This PR:"
          echo "  - Does not merge origin/main"
          echo "  - Does not contain breaking zero-copy commits"
          echo "  - Is safe to merge into venus-stable"
